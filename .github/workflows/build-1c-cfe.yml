name: Build 1C CFE via Docker

on:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Prepare build environment
        run: |
          mkdir -p ./output
          # Создаем скрипт сборки с базовыми функциями
          cat > ./build.os <<EOL
          Перем ИсходнаяПапка, ВыходнойФайл;

          // ===== ВСПОМОГАТЕЛЬНЫЕ ФУНКЦИИ =====
          Функция КаталогСуществует(Путь)
              Попытка
                  Возврат НайтиФайлы(Путь + "/*").Количество() > 0;
              Исключение
                  Возврат Ложь;
              КонецПопытки;
          КонецФункции

          Функция КопироватьФайл(Источник, Приемник)
              Чтение = Новый ЧтениеТекста(Источник);
              Запись = Новый ЗаписьТекста(Приемник);
              Запись.Записать(Чтение.Прочитать());
              Чтение.Закрыть();
              Запись.Закрыть();
          КонецФункции

          // ===== ОСНОВНАЯ ЛОГИКА =====
          Если КоличествоАргументовКоманднойСтроки() < 2 Тогда
              ВызватьИсключение "Необходимо указать: исходная_папка выходной_файл";
          КонецЕсли;

          ИсходнаяПапка = АргументыКоманднойСтроки[0];
          ВыходнойФайл = АргументыКоманднойСтроки[1];

          Если Не КаталогСуществует(ИсходнаяПапка) Тогда
              ВызватьИсключение "Исходная папка не существует: " + ИсходнаяПапка;
          КонецЕсли;

          // Создаем временную папку
          ВременнаяПапка = "/tmp/cfe_build_" + Строка(ТекущаяДата());
          СоздатьКаталог(ВременнаяПапка);

          // Копируем файлы конфигурации
          Файлы = НайтиФайлы(ИсходнаяПапка + "/*");
          Для Каждого Файл Из Файлы Цикл
              Если НРег(Файл.Имя) = "configuration.xml" ИЛИ 
                 НРег(Прав(Файл.Имя, 4)) = ".bsl" Тогда
                  КопироватьФайл(
                      Файл.ПолноеИмя, 
                      ВременнаяПапка + "/" + Файл.Имя
                  );
              КонецЕсли;
          КонецЦикла;

          // Упаковываем в ZIP (CFE)
          ZIP = Новый ЗаписьZIPФайла(ВыходнойФайл);
          Для Каждого Файл Из НайтиФайлы(ВременнаяПапка + "/*") Цикл
              ZIP.Добавить(Файл.ПолноеИмя);
          КонецЦикла;
          ZIP.Записать();
          EOL

      - name: Build with Docker
        run: |
          docker run --rm \
            -v "$(pwd)/src:/src" \
            -v "$(pwd)/output:/output" \
            -v "$(pwd)/build.os:/build.os" \
            evilbeaver/onescript:1.9.2 \
            oscript /build.os /src /output/extension.cfe

      - name: Verify CFE
        run: |
          if [ ! -f "./output/extension.cfe" ]; then
            echo "❌ CFE file not created!"
            exit 1
          fi
          echo "✅ CFE created ($(stat -c%s ./output/extension.cfe) bytes)"
          unzip -l ./output/extension.cfe

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: 1C-CFE
          path: ./output/extension.cfe
