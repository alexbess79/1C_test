name: Build 1C CFE via Docker

on:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Prepare build environment
        run: |
          mkdir -p ./output
          # Создаем минималистичный скрипт сборки
          cat > ./build.os <<EOL
          // Минимальная версия сборщика CFE
          ВходнаяПапка = "src";
          ВыходнойФайл = "output/extension.cfe";
          
          // Создаем ZIP-архив
          ZIP = Новый ЗаписьZIPФайла(ВыходнойФайл);
          
          // Добавляем обязательные файлы
          Попытка
              ZIP.Добавить(ВходнаяПапка + "/Configuration.xml");
              ZIP.Добавить(ВходнаяПапка + "/Модули/Модуль1.bsl");
              ZIP.Добавить(ВходнаяПапка + "/Модули/Модуль2.bsl");
          Исключение
              Вывести("Ошибка: " + ОписаниеОшибки());
              ЗавершитьРаботу(1);
          КонецПопытки;
          
          ZIP.Записать();
          Вывести("CFE успешно создан!");
          EOL

      - name: Build with Docker
        run: |
          docker run --rm \
            -v "$(pwd):/workspace" \
            -w /workspace \
            evilbeaver/onescript:1.9.2 \
            oscript build.os

      - name: Verify CFE
        run: |
          if [ ! -f "./output/extension.cfe" ]; then
            echo "❌ CFE file not created!"
            exit 1
          fi
          echo "✅ CFE created successfully:"
          ls -lh ./output/extension.cfe

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: 1C-CFE
          path: ./output/extension.cfe
